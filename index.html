<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario PONTE ZAFIRO</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .tab-button.active {
            filter: brightness(110%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        .stock-alert-red {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { background-color: #f87171; } /* Red-400 */
            50% { background-color: #dc2626; }    /* Red-600 */
        }
        .stock-card {
            transition: transform 0.2s;
        }
        .stock-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        /* Color Zafiro Intenso (custom) */
        .bg-sapphire { background-color: #0d47a1; }
        .hover\:bg-sapphire-dark:hover { background-color: #0b3c8f; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="text-center mb-8">
        <h1 class="text-5xl font-extrabold text-gray-800 tracking-tight">PONTE ZAFIRO</h1>
        <p class="text-xl text-gray-600 mt-2">Sistema de Gestión de Inventario</p>
    </header>

    <!-- Pestañas de Navegación de Formularios -->
    <div class="mb-8 border-b border-gray-200">
        <nav class="flex flex-wrap -mb-px" id="tab-nav">
            <!-- Pestaña 1: Compras (Verde) -->
            <button class="tab-button py-3 px-4 md:px-6 text-sm font-medium rounded-t-lg transition duration-300 ease-in-out bg-green-600 text-white active" data-tab="registro-compras">
                <i class="fas fa-database mr-2"></i> Registro de Compras
            </button>
            <!-- Pestaña 2: Dispensación (Naranja) -->
            <button class="tab-button py-3 px-4 md:px-6 text-sm font-medium rounded-t-lg transition duration-300 ease-in-out bg-orange-600 text-white ml-2" data-tab="solicitud-dispensacion">
                <i class="fas fa-user-tag mr-2"></i> Solicitud/Dispensación
            </button>
            <!-- Pestaña 3: Venta (Zafiro) -->
            <button class="tab-button py-3 px-4 md:px-6 text-sm font-medium rounded-t-lg transition duration-300 ease-in-out bg-sapphire text-white ml-2" data-tab="registro-venta">
                <i class="fas fa-shopping-cart mr-2"></i> Registro de Venta
            </button>
            <!-- Pestaña 4: Joya Terminada (Rojo) -->
            <button class="tab-button py-3 px-4 md:px-6 text-sm font-medium rounded-t-lg transition duration-300 ease-in-out bg-red-700 text-white ml-2" data-tab="joya-terminada">
                <i class="fas fa-gem mr-2"></i> Joya Terminada
            </button>
        </nav>
    </div>

    <!-- Contenido de Formularios -->
    <div id="form-container" class="bg-white p-6 md:p-10 rounded-xl shadow-lg mb-8">
        <!-- El contenido del formulario se renderizará aquí -->
    </div>

    <!-- Dashboards de Stock -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Tablero de Stock de Insumos -->
        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-600">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-box-open mr-2 text-green-600"></i> Tablero de Stock de Insumos
            </h2>
            <div id="insumo-stock-dashboard" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                <!-- Stock de Insumos se renderizará aquí -->
            </div>
        </div>

        <!-- Tablero de Stock de Joyas Terminadas -->
        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-sapphire">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-ring mr-2 text-sapphire"></i> Tablero de Stock de Joyas Terminadas
            </h2>
            <div id="joya-stock-dashboard" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                <!-- Stock de Joyas se renderizará aquí -->
            </div>
        </div>
    </div>

    <!-- Historial y Exportación -->
    <div class="bg-white p-6 md:p-10 rounded-xl shadow-lg mb-8 border-t-4 border-gray-400">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-history mr-2 text-gray-600"></i> Historial y Exportación de Archivos
        </h2>

        <!-- Filtros de Historial y Exportación -->
        <div class="flex flex-wrap items-end space-y-4 md:space-y-0 md:space-x-4 mb-6 p-4 bg-gray-50 rounded-lg">
            <div>
                <label for="history-type" class="block text-sm font-medium text-gray-700">Seleccionar Historial</label>
                <select id="history-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    <option value="purchases">Registro de Compras (Insumos)</option>
                    <option value="dispensations">Solicitud/Dispensación (Insumos)</option>
                    <option value="finished_goods">Registro de Joya Terminada</option>
                    <option value="sales">Registro de Venta de Joyas</option>
                </select>
            </div>
            <div>
                <label for="start-date" class="block text-sm font-medium text-gray-700">Fecha de Inicio</label>
                <input type="date" id="start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
            </div>
            <div>
                <label for="end-date" class="block text-sm font-medium text-gray-700">Fecha de Fin</label>
                <input type="date" id="end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
            </div>
            <button onclick="renderHistory()" class="bg-gray-800 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                <i class="fas fa-search"></i> Filtrar
            </button>
            <button onclick="exportToExcel()" class="bg-indigo-600 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                <i class="fas fa-file-excel"></i> Exportar a .XLS
            </button>
        </div>

        <!-- Tabla de Historial -->
        <div id="history-table-container" class="overflow-x-auto">
            <!-- La tabla de historial se renderizará aquí -->
        </div>
    </div>

    <script>
        // --- CONSTANTES DE CONFIGURACIÓN ---
        const STOCK_MIN_BASE = 10;
        const PROVEEDORES = ["Santorini", "Inversiones JG"];
        const INS_LIST = [
          "topos goldfield filled liso 1", "Topos Rectángulo Tallado 01 x Par Gold Filled",
          "Topos Circulo Irregular Tallado 03 x Par Gold Filled", "Topos Hexágono Tallado 05 x Par Gold Filled",
          "Aro Para Tejer Gold Filled 2.5cm / x Par", "Aro Para Tejer Gold Filled 3cm / x Par",
          "Aro Para Tejer Gold Filled 3.5cm / x Par", "Herraje Gancho Catalan Dorado De Acero / X Par",
          "Candongas De Acero Doradas / 40mm / X Par", "Candongas De Acero Doradas / 20mm / X Par",
          "Candongas De Acero Doradas / 35mm / X Par", "Gota Para Tejer 3 Centimetros Gold Filled X Par",
          "Triangulo Para Tejer 2 Centimetros Gold Filled X Par", "TERMINAL EN EXTENIÓN DE RODIO",
          "HERRAJE ACERO 20 MM TRIANGULO", "GANCHO PESCADOR ACERO DORADO",
          "HERRAJE TOPO ACERO CIRCULO 20 MM", "HERRAJE ACERO 35 MM CIRCULAR",
          "HERRAJE ACERO 30 MM CIRCULAR", "GANCHO CATALAN ACERO DORADO OVALADO",
          "GANCHO CATALAN ACERO DORADO REDONDO", "HERRAJE TOPO ACERO BARRA 14 MM",
          "HERRAJE TOPO ACERO GOTA", "HERRAJE TOPO ACERO OVALOS",
          "HERRAJE TOPO ACERO TRIANGULO", "HERRAJE TOPO ACERO ABANICO", "MIYUKI DELICA 11/0",
          "Candongas De Acero Doradas / 25mm / X Par"
        ]; // Asegurando que haya 29 insumos
        const JOYAS_LIST = [
          "Arete", "Aro roja", "Gota gris", "Triangulo miyuki", "Candonga 2,0", "Gota roja",
          "Gota multicolor", "Aro azul multicolor", "Aro negro", "Cuadro beige y rojo miyuki",
          "Semitriangulo negro", "Aro multicolor", "Semitriangulo negro+multicolor", "Candonga miyuki rosa",
          "Gota verde", "Aro blanco", "Gota azul", "Juego miyuki rosa", "Aro negra", "Aro verde",
          "Candonga Miyuki gris+dorado+blanco", "Juego miyuki lila", "Candonga pequeña", "Juego miyuki negro",
          "Manilla miyuki dorada+nude", "Manilla roja balines", "Triangulo negro miyuki", "Semitriangulo",
          "Triangulo rosa miyuki", "Manilla azul", "maillas mamá", "anillos", "Manilla triangulo"
        ]; // 33 joyas
        const INSUMO_IMAGE_URL = 'https://placehold.co/64x64/22c55e/ffffff?text=Insumo';
        const JOYA_IMAGE_URL = 'https://placehold.co/64x64/0d47a1/ffffff?text=Joya';


        // --- ESTRUCTURA DE DATOS INICIAL ---
        let state = {
            stock_supplies: {},
            stock_jewelry: {},
            history_purchases: [],
            history_dispensations: [],
            history_sales: [],
            history_finished_goods: [],
            nextInvoiceNumber: 1
        };

        // --- FUNCIONES DE PERSISTENCIA (localStorage) ---
        function loadState() {
            try {
                const persistedState = localStorage.getItem('ponte_zafiro_inventory_state');
                if (persistedState) {
                    state = JSON.parse(persistedState);
                } else {
                    // Inicializar stocks a 0 si es la primera carga
                    INS_LIST.forEach(insumo => { state.stock_supplies[insumo] = 0; });
                    JOYAS_LIST.forEach(joya => { state.stock_jewelry[joya] = 0; });
                }
            } catch (error) {
                console.error("Error cargando el estado de localStorage:", error);
                // Forzar inicialización si hay un error
                INS_LIST.forEach(insumo => { state.stock_supplies[insumo] = 0; });
                JOYAS_LIST.forEach(joya => { state.stock_jewelry[joya] = 0; });
            }
        }

        function saveState() {
            try {
                localStorage.setItem('ponte_zafiro_inventory_state', JSON.stringify(state));
                console.log("Estado guardado en localStorage.");
            } catch (error) {
                console.error("Error guardando el estado en localStorage:", error);
            }
        }

        // --- LÓGICA DE NEGOCIO ---

        function generateNextInvoiceNumber() {
            const invoice = state.nextInvoiceNumber.toString().padStart(6, '0');
            state.nextInvoiceNumber++;
            return `FACT-${invoice}`;
        }

        function handlePurchaseRegistration(event) {
            event.preventDefault();
            const form = event.target;
            const invoice = generateNextInvoiceNumber();
            const insumo = form['insumo-compra'].value;
            const proveedor = form['proveedor'].value;
            const cantidad = parseInt(form['cantidad-comprada'].value, 10);
            const date = new Date().toISOString();

            if (cantidad > 0) {
                // 1. Actualizar Stock
                state.stock_supplies[insumo] = (state.stock_supplies[insumo] || 0) + cantidad;

                // 2. Registrar Historial
                state.history_purchases.unshift({
                    date,
                    invoice,
                    proveedor,
                    insumo,
                    cantidad,
                    type: 'Compra'
                });

                saveState();
                form.reset();
                // Actualizar el número de factura en el UI
                document.getElementById('no-factura').value = generateNextInvoiceNumber();
                renderStockDashboards();
                showMessage('Compra de insumos registrada con éxito.', 'success');
            } else {
                showMessage('La cantidad debe ser positiva.', 'error');
            }
        }

        function handleFinishedGoodsRegistration(event) {
            event.preventDefault();
            const form = event.target;
            const joya = form['nombre-joya'].value;
            const cantidad = parseInt(form['cantidad-terminada'].value, 10);
            const date = new Date().toISOString();

            if (cantidad > 0) {
                // 1. Actualizar Stock
                state.stock_jewelry[joya] = (state.stock_jewelry[joya] || 0) + cantidad;

                // 2. Registrar Historial
                state.history_finished_goods.unshift({
                    date,
                    joya,
                    cantidad,
                    type: 'Terminada'
                });

                saveState();
                form.reset();
                renderStockDashboards();
                showMessage('Registro de joya terminada con éxito.', 'success');
            } else {
                showMessage('La cantidad debe ser positiva.', 'error');
            }
        }

        function handleDispensation(event) {
            event.preventDefault();
            const form = event.target;
            const insumo = form['insumo-dispensacion'].value;
            const solicitante = form['solicitante'].value;
            const cantidad = parseInt(form['cantidad-entregada'].value, 10);
            const date = new Date().toISOString();

            const currentStock = state.stock_supplies[insumo] || 0;

            if (cantidad > 0) {
                if (currentStock >= cantidad) {
                    // 1. Actualizar Stock
                    state.stock_supplies[insumo] -= cantidad;

                    // 2. Registrar Historial
                    state.history_dispensations.unshift({
                        date,
                        solicitante,
                        insumo,
                        cantidad,
                        type: 'Dispensación'
                    });

                    saveState();
                    form.reset();
                    renderStockDashboards();
                    showMessage(`Dispensación de ${cantidad} unidades de ${insumo} registrada.`, 'success');
                } else {
                    showMessage(`Stock insuficiente. Solo hay ${currentStock} unidades de ${insumo}.`, 'error');
                }
            } else {
                showMessage('La cantidad debe ser positiva.', 'error');
            }
        }

        function handleSaleRegistration(event) {
            event.preventDefault();
            const form = event.target;
            const joya = form['joya-vendida'].value;
            const cantidad = parseInt(form['cantidad-vendida'].value, 10);
            const date = new Date().toISOString();

            const currentStock = state.stock_jewelry[joya] || 0;

            if (cantidad > 0) {
                if (currentStock >= cantidad) {
                    // 1. Actualizar Stock
                    state.stock_jewelry[joya] -= cantidad;

                    // 2. Registrar Historial
                    state.history_sales.unshift({
                        date,
                        joya,
                        cantidad,
                        type: 'Venta'
                    });

                    saveState();
                    form.reset();
                    renderStockDashboards();
                    showMessage(`Venta de ${cantidad} unidades de ${joya} registrada.`, 'success');
                } else {
                    showMessage(`Stock insuficiente de joyas. Solo hay ${currentStock} unidades de ${joya}.`, 'error');
                }
            } else {
                showMessage('La cantidad debe ser positiva.', 'error');
            }
        }

        // --- RENDERING Y UI ---

        function showMessage(message, type) {
            const container = document.getElementById('form-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `p-4 mb-4 rounded-lg text-white font-medium shadow-md ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            alertDiv.textContent = message;

            container.prepend(alertDiv);
            setTimeout(() => alertDiv.remove(), 4000);
        }

        function renderStockDashboards() {
            const insumoDashboard = document.getElementById('insumo-stock-dashboard');
            const joyaDashboard = document.getElementById('joya-stock-dashboard');
            insumoDashboard.innerHTML = '';
            joyaDashboard.innerHTML = '';

            // Renderizar Stock de Insumos
            Object.keys(state.stock_supplies).forEach(insumo => {
                const stock = state.stock_supplies[insumo];
                const isLow = stock < STOCK_MIN_BASE;
                const colorClass = isLow ? 'bg-red-200 text-red-800 stock-alert-red' : 'bg-green-200 text-green-800';

                insumoDashboard.innerHTML += `
                    <div class="stock-card p-3 rounded-lg flex justify-between items-center shadow-sm ${isLow ? 'border-l-4 border-red-600' : 'border-l-4 border-green-600'}">
                        <div class="flex items-center">
                            <img src="${INSUMO_IMAGE_URL}" class="w-8 h-8 rounded mr-3 hidden md:block" alt="Insumo">
                            <span class="font-medium text-sm">${insumo}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-xs font-semibold block text-gray-500">Stock</span>
                            <span class="text-lg font-bold ${colorClass.includes('red') ? 'text-red-700' : 'text-green-700'}">${stock}</span>
                            ${isLow ? `<span class="inline-flex items-center text-xs font-bold ${colorClass} py-1 px-2 rounded-full ml-2"><i class="fas fa-exclamation-triangle mr-1"></i> Alerta Mínimo (${STOCK_MIN_BASE})</span>` : ''}
                        </div>
                    </div>
                `;
            });

            // Renderizar Stock de Joyas
            Object.keys(state.stock_jewelry).forEach(joya => {
                const stock = state.stock_jewelry[joya];
                const isLow = stock < STOCK_MIN_BASE;
                const colorClass = isLow ? 'bg-red-200 text-red-800 stock-alert-red' : 'bg-green-200 text-green-800';

                joyaDashboard.innerHTML += `
                    <div class="stock-card p-3 rounded-lg flex justify-between items-center shadow-sm ${isLow ? 'border-l-4 border-red-600' : 'border-l-4 border-green-600'}">
                        <div class="flex items-center">
                            <img src="${JOYA_IMAGE_URL}" class="w-8 h-8 rounded mr-3 hidden md:block" alt="Joya">
                            <span class="font-medium text-sm">${joya}</span>
                        </div>
                        <div class="text-right flex items-center">
                            <div class="mr-4">
                                <span class="text-xs font-semibold block text-gray-500">Stock</span>
                                <span class="text-lg font-bold ${colorClass.includes('red') ? 'text-red-700' : 'text-green-700'}">${stock}</span>
                            </div>
                            ${isLow ? `<span class="inline-flex items-center text-xs font-bold ${colorClass} py-1 px-2 rounded-full ml-2"><i class="fas fa-exclamation-triangle mr-1"></i> Alerta Mínimo (${STOCK_MIN_BASE})</span>` : ''}
                        </div>
                    </div>
                `;
            });

            if (Object.keys(state.stock_supplies).length === 0) insumoDashboard.innerHTML = `<p class="text-gray-500">No hay insumos registrados.</p>`;
            if (Object.keys(state.stock_jewelry).length === 0) joyaDashboard.innerHTML = `<p class="text-gray-500">No hay joyas registradas.</p>`;
        }

        function renderForm(tabName) {
            const container = document.getElementById('form-container');
            let formHtml = '';
            let submitHandler = '';
            let formColor = '';

            // Definir el contenido del formulario según la pestaña
            switch (tabName) {
                case 'registro-compras':
                    formColor = 'border-green-600';
                    submitHandler = 'handlePurchaseRegistration(event)';
                    formHtml = `
                        <h3 class="text-2xl font-semibold mb-6 text-green-700 flex items-center"><i class="fas fa-plus-circle mr-3"></i> Registro de Compras de Insumos</h3>
                        <form onsubmit="${submitHandler}">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="no-factura" class="block text-sm font-medium text-gray-700">No. de Factura (Automático)</label>
                                    <input type="text" id="no-factura" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 bg-gray-100 cursor-not-allowed" value="${generateNextInvoiceNumber()}" readonly>
                                </div>
                                <div>
                                    <label for="proveedor" class="block text-sm font-medium text-gray-700">Proveedor</label>
                                    <select id="proveedor" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                                        ${PROVEEDORES.map(p => `<option value="${p}">${p}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label for="insumo-compra" class="block text-sm font-medium text-gray-700">Insumo Comprado</label>
                                    <select id="insumo-compra" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                                        ${INS_LIST.map(i => `<option value="${i}">${i}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label for="cantidad-comprada" class="block text-sm font-medium text-gray-700">Cantidad Comprada</label>
                                    <input type="number" id="cantidad-comprada" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                                </div>
                            </div>
                            <div class="mt-8">
                                <button type="submit" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                                    <i class="fas fa-check-circle mr-2"></i> Registrar Compra
                                </button>
                            </div>
                        </form>
                    `;
                    break;

                case 'solicitud-dispensacion':
                    formColor = 'border-orange-600';
                    submitHandler = 'handleDispensation(event)';
                    formHtml = `
                        <h3 class="text-2xl font-semibold mb-6 text-orange-700 flex items-center"><i class="fas fa-share-square mr-3"></i> Solicitud/Dispensación de Insumos</h3>
                        <form onsubmit="${submitHandler}">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="solicitante" class="block text-sm font-medium text-gray-700">Solicitante (Artesano/a)</label>
                                    <input type="text" id="solicitante" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border" placeholder="Nombre del Artesano/a">
                                </div>
                                <div>
                                    <label for="insumo-dispensacion" class="block text-sm font-medium text-gray-700">Insumo Entregado</label>
                                    <select id="insumo-dispensacion" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                                        ${INS_LIST.map(i => `<option value="${i}">${i}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label for="cantidad-entregada" class="block text-sm font-medium text-gray-700">Cantidad Entregada</label>
                                    <input type="number" id="cantidad-entregada" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                                </div>
                            </div>
                            <div class="mt-8">
                                <button type="submit" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition duration-150">
                                    <i class="fas fa-truck-loading mr-2"></i> Dispensar Insumo
                                </button>
                            </div>
                        </form>
                    `;
                    break;

                case 'registro-venta':
                    formColor = 'border-sapphire';
                    submitHandler = 'handleSaleRegistration(event)';
                    formHtml = `
                        <h3 class="text-2xl font-semibold mb-6 text-sapphire flex items-center"><i class="fas fa-cash-register mr-3"></i> Registro de Venta de Joyas</h3>
                        <form onsubmit="${submitHandler}">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="joya-vendida" class="block text-sm font-medium text-gray-700">Joya Vendida</label>
                                    <select id="joya-vendida" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                                        ${JOYAS_LIST.map(j => `<option value="${j}">${j}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label for="cantidad-vendida" class="block text-sm font-medium text-gray-700">Cantidad Vendida</label>
                                    <input type="number" id="cantidad-vendida" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                                </div>
                            </div>
                            <div class="mt-8">
                                <button type="submit" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-sapphire hover:bg-sapphire-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                                    <i class="fas fa-dollar-sign mr-2"></i> Registrar Venta
                                </button>
                            </div>
                        </form>
                    `;
                    break;

                case 'joya-terminada':
                    formColor = 'border-red-700';
                    submitHandler = 'handleFinishedGoodsRegistration(event)';
                    formHtml = `
                        <h3 class="text-2xl font-semibold mb-6 text-red-700 flex items-center"><i class="fas fa-tools mr-3"></i> Registro de Joya Terminada</h3>
                        <form onsubmit="${submitHandler}">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="nombre-joya" class="block text-sm font-medium text-gray-700">Nombre de la Joya</label>
                                    <select id="nombre-joya" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                                        ${JOYAS_LIST.map(j => `<option value="${j}">${j}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label for="cantidad-terminada" class="block text-sm font-medium text-gray-700">Cantidad Terminada</label>
                                    <input type="number" id="cantidad-terminada" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                                </div>
                            </div>
                            <div class="mt-8">
                                <button type="submit" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-red-700 hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-600 transition duration-150">
                                    <i class="fas fa-plus-square mr-2"></i> Añadir a Stock
                                </button>
                            </div>
                        </form>
                    `;
                    break;

                default:
                    formHtml = '<p class="text-gray-500">Seleccione una opción.</p>';
            }

            container.innerHTML = `<div class="p-6 rounded-xl border-t-4 ${formColor}">${formHtml}</div>`;
        }

        // --- MANEJO DE PESTAÑAS ---
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-button');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    renderForm(tab.dataset.tab);
                });
            });
            // Cargar la pestaña activa por defecto al iniciar
            document.querySelector('.tab-button.active').click();
        }

        // --- HISTORIAL Y EXPORTACIÓN ---

        function renderHistory() {
            const type = document.getElementById('history-type').value;
            const startDateStr = document.getElementById('start-date').value;
            const endDateStr = document.getElementById('end-date').value;

            let data = [];
            let headers = [];
            let title = '';

            switch (type) {
                case 'purchases':
                    data = state.history_purchases;
                    headers = ['Fecha', 'No. Factura', 'Proveedor', 'Insumo', 'Cantidad', 'Tipo'];
                    title = 'Registro de Compras (Insumos)';
                    break;
                case 'dispensations':
                    data = state.history_dispensations;
                    headers = ['Fecha', 'Solicitante', 'Insumo', 'Cantidad', 'Tipo'];
                    title = 'Solicitud/Dispensación (Insumos)';
                    break;
                case 'finished_goods':
                    data = state.history_finished_goods;
                    headers = ['Fecha', 'Joya', 'Cantidad', 'Tipo'];
                    title = 'Registro de Joya Terminada';
                    break;
                case 'sales':
                    data = state.history_sales;
                    headers = ['Fecha', 'Joya', 'Cantidad', 'Tipo'];
                    title = 'Registro de Venta de Joyas';
                    break;
            }

            // Aplicar filtro de fecha
            const filteredData = data.filter(item => {
                const itemDate = new Date(item.date.split('T')[0]);
                let isAfterStart = true;
                let isBeforeEnd = true;

                if (startDateStr) {
                    isAfterStart = itemDate >= new Date(startDateStr);
                }
                if (endDateStr) {
                    isBeforeEnd = itemDate <= new Date(endDateStr);
                }
                return isAfterStart && isBeforeEnd;
            });

            // Construir la tabla HTML
            let tableHtml = `<h4 class="text-xl font-medium mb-3">${title} (${filteredData.length} registros)</h4>`;
            tableHtml += '<table class="min-w-full divide-y divide-gray-200 border rounded-lg shadow-md">';
            tableHtml += '<thead class="bg-gray-50"><tr class="text-xs font-medium text-gray-500 uppercase tracking-wider">';
            headers.forEach(h => tableHtml += `<th class="px-6 py-3 text-left">${h}</th>`);
            tableHtml += '</tr></thead>';
            tableHtml += '<tbody class="bg-white divide-y divide-gray-200">';

            filteredData.forEach(item => {
                tableHtml += '<tr>';
                tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(item.date).toLocaleString()}</td>`;
                if (type === 'purchases') {
                    tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.invoice}</td>`;
                    tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.proveedor}</td>`;
                    tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.insumo}</td>`;
                } else if (type === 'dispensations') {
                    tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 flex items-center"><i class="fas fa-user mr-2 text-orange-500"></i>${item.solicitante}</td>`;
                    tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.insumo}</td>`;
                } else if (type === 'finished_goods' || type === 'sales') {
                    tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.joya}</td>`;
                }
                tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-center font-bold ${item.type === 'Venta' || item.type === 'Dispensación' ? 'text-red-600' : 'text-green-600'}">${item.cantidad}</td>`;
                tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">${item.type}</td>`;
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';

            document.getElementById('history-table-container').innerHTML = tableHtml;
        }


        function exportToExcel() {
            const type = document.getElementById('history-type').value;
            const startDateStr = document.getElementById('start-date').value;
            const endDateStr = document.getElementById('end-date').value;

            let data = [];
            let headers = [];
            let fileName = '';

            switch (type) {
                case 'purchases':
                    data = state.history_purchases;
                    headers = ['Fecha', 'No. Factura', 'Proveedor', 'Insumo', 'Cantidad', 'Tipo'];
                    fileName = 'Registro_Compras_Insumos';
                    break;
                case 'dispensations':
                    data = state.history_dispensations;
                    headers = ['Fecha', 'Solicitante', 'Insumo', 'Cantidad', 'Tipo'];
                    fileName = 'Registro_Dispensacion_Insumos';
                    break;
                case 'finished_goods':
                    data = state.history_finished_goods;
                    headers = ['Fecha', 'Joya', 'Cantidad', 'Tipo'];
                    fileName = 'Registro_Joya_Terminada';
                    break;
                case 'sales':
                    data = state.history_sales;
                    headers = ['Fecha', 'Joya', 'Cantidad', 'Tipo'];
                    fileName = 'Registro_Venta_Joyas';
                    break;
            }

            // Aplicar filtro de fecha
            const filteredData = data.filter(item => {
                const itemDate = new Date(item.date.split('T')[0]);
                let isAfterStart = true;
                let isBeforeEnd = true;

                if (startDateStr) {
                    isAfterStart = itemDate >= new Date(startDateStr);
                }
                if (endDateStr) {
                    isBeforeEnd = itemDate <= new Date(endDateStr);
                }
                return isAfterStart && isBeforeEnd;
            });

            if (filteredData.length === 0) {
                showMessage('No hay datos para exportar en el rango de fechas seleccionado.', 'error');
                return;
            }

            // Crear el contenido CSV
            let csvContent = headers.join('\t') + '\n'; // Usar tabulador como separador
            filteredData.forEach(item => {
                let row = [];
                switch (type) {
                    case 'purchases':
                        row = [
                            new Date(item.date).toLocaleString(),
                            item.invoice,
                            item.proveedor,
                            item.insumo,
                            item.cantidad,
                            item.type
                        ];
                        break;
                    case 'dispensations':
                        row = [
                            new Date(item.date).toLocaleString(),
                            item.solicitante,
                            item.insumo,
                            item.cantidad,
                            item.type
                        ];
                        break;
                    case 'finished_goods':
                    case 'sales':
                        row = [
                            new Date(item.date).toLocaleString(),
                            item.joya,
                            item.cantidad,
                            item.type
                        ];
                        break;
                }
                csvContent += row.join('\t') + '\n';
            });

            // Generar el archivo XLS (en realidad es un TSV/CSV con extensión .xls para compatibilidad)
            const link = document.createElement('a');
            link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
            link.download = `${fileName}_${startDateStr}_a_${endDateStr}.xls`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage(`Exportación de ${fileName} (${filteredData.length} registros) completada.`, 'success');
        }

        // --- INICIALIZACIÓN ---
        window.onload = function() {
            loadState();
            setupTabs();
            renderStockDashboards();
            renderHistory(); // Cargar historial inicial al cargar la página
        };

    </script>
</body>
</html>
